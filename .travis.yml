sudo: required
services:
  - docker

language: go
notifications:
  email: false

go:
  - "1.10.x"

jobs:
  include:
    - stage: test
      script:
        - make lint
    - stage: test
      script:
        - cd test_env
        - docker-compose -f docker-compose.yml up -d
        - cd ..
        - sleep 35s
        - make test

    - stage: build
      if: branch = master
      script:
        - make bin VERSION=latest
    - stage: build
      if: branch = master
      script:
        - make docker VERSION=latest
    - stage: build
      if: branch = develop
      script:
        - make bin VERSION=test
    - stage: build
      if: branch = develop
      script:
        - make docker VERSION=test
    - stage: build
      if: tag =~ ^[0-9]+\.[0-9]+\.[0-9]+
      script:
        - make bin VERSION=${TRAVIS_TAG}
        - ls build
      deploy: &github
        provider: releases
        api_key:
          secure: Kc6RbhmfHWMCjlKLWSWqlaFKM7Z4kxs2I1Sd7q8Nthw32lPuQ3cSO2YEURWvtPTV5xrJIcW5HP4utSKl9b/h0eXVqluUpVjxbCqgB4iwdj7WWutswnpvXIhlmFzacngMXHCY6363Myoq3rZtIJ8KXr1pLYBQ4Ik3ePsJ8hCzUQm7L9JsxSVGDhLlEVsEjLdBMKZ7/XBCcn/tgbT/wDs+Ru3IoXpIhTjJbEiOriP38viPgHvqbJmjn2HNqK0oP8RT5Bx2o7IUJaXgdsFBOtq/r2sqKuxWk4nBb2B7qvOdjs8nQQ+xKkIcTKwQ0uB2emHCYoPdh8jtXrvPEHmZ1UqzVuCem3WjKm4Hea1DYMaJOtEylpjWtWlyYVdMicQhVvjCgtwTacM7o7fddmnggWxbpI+ESTrV84T24NLHO2kRYTGe0fvmkNZGmWJNSDMg+wl5YPup2Em/j1Rim67bzxj7HcvwdMW2sL+gGs0YjQi0ubHuLg03Lj27i8Y3HEx107bsop1ocbWSyM7q/KLUhIYo33SJyEH2K6KuJgF5SozLBWoC7XCz5tiaegxSJd4w965mlAC2TNPJm5KBw7J/g27TpDY5JSvwYHtpQg1GdHNV7XEPcFZa0hxFyFl+dOGerz2ObZRaMsQxFP08rrjXAHCTkYjqNztSieW+aEUnkP7iO3o=
        file: 
          - "build/virity-server-linux-amd64-v${TRAVIS_TAG}"
          - "build/virity-agent-linux-amd64-v${TRAVIS_TAG}"
        skip_cleanup: true
        on:
          tags: true
    - stage: build
      if: tag =~ ^[0-9]+\.[0-9]+\.[0-9]+
      script:
        - make docker VERSION=${TRAVIS_TAG}
env:
  matrix:
  - secure: ilGH9/1NuMtEoNXdEAVLWYafvMXGcC7SkTd0GXlBANeaEF/kLjIIgMOFXIH7uCAvow4u7ead0CcAe/QMP49yE/cakbUzy5+FpIY5Z+fTqwryffeLZluUSSD/vt2reT4tnKA6tfdwruQdpVFt+LZt8QxY0Uaiw3rIIJR2Pzfdi4788QzME4EQkRNlGwyYf/YPXQAEdcR/4cTmbFVdsMwpokmp8EDJ5T2tBJxo7T+w9fZILieAPZCcZD9SBzwmHIndJMOIhqtqwEjXqqXIE8osPntZkOPnBuy1RXJWz73YsXX9QDPK8TnLNJ+KA3BojXia4NgiYXjAUgliKJpg+JvAd0EH8K9ZHbsUBJIJt4YB9uYjK8u8fsqwh16mtGrMuSzoyt6PBcZqkBdgUg8NdQ5GFRn8DER/K+49Okd6BvSdnFmGJvAQUKjbkbRUOnFFvvwsbmwoxYDK3f3m9jB7y8YMKsYQNvzT3MP3AS+EHsNoyMtGrIsejIaLgUH1KAKBJzKgsURpUsQE2oaIyzCpNI1CnSCY20nNhBq0/LJ80jHHKevc0JnEmefnUn235KJoSbi80Vh1DCpk4yXmlSG5hNkSPWfXr9CBrZ04II6oaHJwg2RXaHbuk/YFctVlfaUHr9w/Pm8mGgBkoym1WwYrX1XMaQCqbGGysq3eys74Olrcba4=
  - secure: Tc4cDIwNLkpDkAPhZuoGsdmzzvXTy1CAgJbOVGn9MjH+YmjSDXsT/A7tVgPI3OkJWg025ZmJmyoMFnZzIuGJ8A9IxH7rD6Owkah8HIBFuQkEMC1sy2l/xfdteh495DBJLpF10Pnp1QRaItvfuIWXh0Y3SQZ8C1tRAylxip6ftn0ZbJoXCpv0ZyKtG2NEWLTvr45F1K4ZecyKkc5/cB6bB7VMEP5FsMjMFLjHwqsiiEodmoL9LtKVuCoJKjcsMyhwzbwDAJP/PxE4SEQnVSJDZGRBp6LV6qN5Sr3+6SouTRsuqk4Mz/toKa1FOCfKlc4vdOciG/i0Yo9MYOjbCNTzH+H9UBrIhF0sDEcxUaSlJX1LbNhl1k1/lqa9NNzKYJUf1MrN+b+2wO08EMIy6h5QxxXy5f+PKuHHyti7A6h5d8lIH20q5ukkZ87u1YC3CiaWf/kxeuvYfa9/mgceFQhPpJhXHWS7U7Pbr1VjGHkEJNuLTfPBEVxG7CQZIjtkRxbnG9Isk5xV8nZ//h2Vjx2QOCVRmXw1HyAi7u9N3thBPMxqvpqIdblp2lKvjj5isC1kd8l2z7KDwtuGOfaYrRW/2PcSJORycMGB9QmqDHI9D2Wsyr7nGmo9wa66idCl6uJfnntjgzWeGHeMHFr90XpH1p4EBPTxa9ljNsDLzt+hI1o=